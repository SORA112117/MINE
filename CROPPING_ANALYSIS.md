# クロッピング機能の問題分析と再設計

## 🔴 現状の根本的問題点

### 1. アーキテクチャの混乱
- **問題**: クロップ枠を動かすのか、中の動画を動かすのか不明確
- **現状**: ピンチ・パン操作が枠自体を変形させている
- **理想**: iPhone写真アプリのように、枠は固定で中身を動かす

### 2. ジェスチャー認識の問題
- **問題**: ピンチとパンが同時に枠を変形させて予期しない動作
- **現状**: 単一のビューで全ジェスチャーを処理
- **理想**: 
  - クロップ枠のハンドル → 枠サイズ変更
  - 枠内でのジェスチャー → 動画の移動・ズーム

### 3. 座標変換の複雑性
```swift
// 現在の問題のあるコード
let baseFrame = calculateInitialCropFrame()
let scaledWidth = baseFrame.width / currentScale
let centerX = baseFrame.midX + currentTranslation.x
// → 複数の変換が絡み合って複雑
```

### 4. 制約システムの反発
- **問題**: constrainTranslation/constrainScaleが急激な補正を行う
- **現状**: 境界に達すると急に止まる・戻る
- **理想**: 弾性的な境界（elastic boundary）

### 5. ハンドル操作の欠如
- **問題**: コーナーや辺をドラッグできない
- **現状**: 描画はされているが、インタラクティブでない
- **理想**: 8点ハンドル（4コーナー + 4辺）

## 🎯 iPhone純正写真アプリのクロップ動作分析

### 動作フロー
1. **初期表示**: 画像全体が表示され、クロップ枠が画像境界に配置
2. **枠の調整**: 
   - コーナーハンドル → 比率を保持せずにサイズ変更
   - 辺ハンドル → 一方向のみサイズ変更
3. **画像の調整**:
   - 枠内でピンチ → 画像のズーム
   - 枠内でパン → 画像の移動
4. **制約**:
   - 画像は常にクロップ枠を完全に覆う
   - クロップ枠は画像境界を超えない

### UI要素
- **ハンドル**: 明確な視覚的フィードバック
- **グリッド**: 操作中のみ表示
- **マスク**: クロップ範囲外を暗く表示
- **リセット**: ダブルタップで元に戻る

## 🚀 新しいクロッピングアーキテクチャ設計

### コンポーネント構成
```
ProCropSystem/
├── ProCropContainerView (全体管理)
├── ProCropFrameView (枠とハンドル)
├── ProCropContentView (動画表示とズーム・パン)
└── ProCropOverlayView (マスクとグリッド)
```

### 責任分離
1. **ProCropContainerView**: 全体の調整と状態管理
2. **ProCropFrameView**: クロップ枠のサイズ変更
3. **ProCropContentView**: 動画のズーム・パン
4. **ProCropOverlayView**: 視覚的フィードバック

### ジェスチャー処理
```
タッチ位置判定
├── ハンドル上 → ProCropFrameView.handleResize()
├── 枠内 → ProCropContentView.handlePanZoom()
└── 枠外 → 無視
```

### 座標システム
```
1. Container座標 (画面座標)
2. Frame座標 (クロップ枠座標)
3. Content座標 (動画座標)

変換は単一方向：
Container → Frame → Content
```

## 🔧 実装戦略

### Phase 1: クリーンアーキテクチャ
- 既存の複雑なコードを削除
- 新しいコンポーネント構造を作成
- 責任を明確に分離

### Phase 2: ハンドル実装
- 8点ハンドル（4コーナー + 4辺）
- タッチ判定とビジュアルフィードバック
- スムーズなリサイズアニメーション

### Phase 3: コンテンツ操作
- 枠内でのピンチズーム
- 枠内でのパン移動
- 弾性境界の実装

### Phase 4: 視覚的改善
- プロフェッショナルなハンドルデザイン
- 操作中のみグリッド表示
- スムーズなマスクアニメーション

## 📊 成功指標

1. **操作性**: iPhone純正アプリと同等の直感性
2. **レスポンス**: 60fps維持
3. **精度**: ピクセル単位の正確な操作
4. **視覚品質**: プロフェッショナルなUI
5. **安定性**: クラッシュ・反発なし